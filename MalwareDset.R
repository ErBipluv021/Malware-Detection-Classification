#For creating dummy variables we need to install and load dummies package
install.packages("dummies")
library(dummies)
library(tidyverse)
library(ggplot2)
library(factoextra)
library(readr)
data = read_csv("C:/Users/zarak/Downloads/Malware.csv")
View(data)
set.seed(10498091)

#Selecting 350 data sample randomly
selected.rows = sample(1:nrow(data),size=350,replace = FALSE)

#Creting sub-sample of 350 dataset excluding 1st column
mydata = data[selected.rows,2:11]
dim(mydata)
View(mydata)

#Checking the summary to find out the NA in the dataset at first
#For the feature verified as malware
table(mydata$`Verified as Malware`, exclude = NULL)

#For the feature outside network
table(mydata$`outside network`,exclude = NULL)
View(mydata)
summary(mydata$`outside network`)
summary(mydata$`Verified as Malware`)
summary(mydata)
glimpse(mydata)



#Function using piping to replace missing values into No for the two features
mydata <- mydata %>%
  mutate(`outside network` = replace(`outside network`, is.na(`outside network`), "No"))
mydata <- mydata %>%
  mutate(`Verified as Malware` = replace(`Verified as Malware`, is.na(`Verified as Malware`), "No"))
View(mydata)


#Creating dummy variables for the features given 
#i.e., converting the categorical values into numerical values for PCA
mydata = cbind(mydata,dummy(mydata$`inc excutable`,sep = "IExecutable."))
mydata = cbind(mydata,dummy(mydata$`inc ZIP`,sep = "IZIP."))
mydata = cbind(mydata,dummy(mydata$`inc PDF`,sep = "IPDF."))
mydata = cbind(mydata,dummy(mydata$`inc DOC`,sep = "IDOC."))
mydata = cbind(mydata,dummy(mydata$`Unknown Format`,sep = "Unknown."))
mydata = cbind(mydata,dummy(mydata$`outside network`,sep = "OutNet."))
mydata = cbind(mydata,dummy(mydata$`Verified as Malware`,sep = "VAMal."))
#Deleting or merging the two yes/no dummy variables into one prior to PCA
mydata=mydata[ , -which(names(mydata) %in% 
                    c("mydataIExecutable.No","mydataIZIP.No","mydataIPDF.No",
                           "mydataIDOC.No","mydataUnknown.No","mydataOutNet.No",
                                             "mydataVAMal.No"))]

#writing the standarized and cleaned data set into csv file
write.csv(mydata,"CleanedMalwareset.csv")

#Viewing the updated data set using View function
View(mydata)

#Now, creating the dataframe for PCA analysis
malw = data.frame(mydata$`Num attachments`,mydata$`URL count`,mydata$`Email Size`,mydata$mydataIExecutable.Yes
                        ,mydata$mydataIZIP.Yes,mydata$mydataIDOC.Yes,mydata$mydataIPDF.Yes,mydata$mydataUnknown.Yes,
                          mydata$mydataOutNet.Yes)
View(malw)
dim(malw)

#Changing the columns name which makes it more readable
colnames(malw)
names(malw)[names(malw) == "mydata..Num.attachments."] <- "Num Attachments"
names(malw)[names(malw) == "mydata.mydataIExecutable.Yes"] <- "Executable"
names(malw)[names(malw) == "mydata.mydataIPDF.Yes"] <- "INC PDF"
names(malw)[names(malw) == "mydata..URL.count."] <- "URL COUNT"
names(malw)[names(malw) == "mydata.mydataIDOC.Yes"] <- "INC DOC"
names(malw)[names(malw) == "mydata.mydataIZIP.Yes"] <- "INC ZIP"
names(malw)[names(malw) == "mydata.mydataUnknown.Yes"] <- "Unknown Format"
names(malw)[names(malw) == "mydata..Email.Size."] <- "Email Size"
names(malw)[names(malw) == "mydata.mydataOutNet.Yes"] <- "Outside Network"
View(malw)


#PCA calculation excluding Verified as malware
pca.malw = prcomp(malw,scale = TRUE); 
pca.malw
summary(pca.malw)

#Coefficients or loadings given by the variables from PCA 
View(pca.malw$x)
summary(pca.malw$x)

#loading of PCA
pca.malw$rotation #This loading is for the 9 components
pca.malw$rotation[,1:3] #loadings for PCA 1,2 and 3 as these components describe the most variability among the rest

#For the purpose of report, this step has been done:
a=round(pca.malw$rotation[,1:3],2); a
write.csv(a,"coef.csv")

#scree plot of PCA
screeplot(pca.malw,type="line",main="Scree Plot")

#Scree plot using ggplot for the PCA
varex.malw = summary(pca.malw)$importance; varex.malw

scpl = data.frame(Variance = varex.malw[2,],PC = 1:length(pca.malw$sdev));
ggplot(scpl,aes(PC,Variance))+
  geom_line(colour="purple", size = 1.5, linetype=2)+
  geom_point(size=5)+
  theme_minimal(base_size = 14)+
  xlab("Principal Component")+
  ylab("Proportion(%) of Variance")+
  scale_x_discrete(limits = paste("PC", 1:length(pca.malw$sdev),sep = ""))

#Vizualizing PC1 against PC2 on the graph for the malware verification
df <- data.frame(pca.malw$x, #PCA scores
                 Malware = mydata$`Verified as Malware`);
ggplot(df,aes(x=PC1,y=PC2))+
  geom_point(aes(colour= Malware),alpha=0.8,size=4)+
  theme_minimal(base_size=14)+
  theme(legend.position = "top")+
  xlab("PC1")+
  ylab("PC2");

#biplot for the PCA
biplot(pca.malw)
fviz_pca_biplot(pca.malw,
                axes = c(1,2), #Specifying the PCs to be plotted.
                #Parameters for samples
                col.ind=mydata$`Verified as Malware`, #Outline colour of the shape
                fill.ind=mydata$`Verified as Malware`, #fill colour of the shape
                 alpha=0.5, #transparency of the fill colour
                pointsize=4, #Size of the shape
                pointshape=21, #Type of Shape
                #Parameter for variables
                col.var="blue", #Colour of the variable labels
                label="var", #Show the labels for the variables only
                repel=TRUE, #Avoid label overplotting
                addEllipses=TRUE,
                legend.title=list(colour="Malware",fill="Malware",alpha="Malware"))  #Add ellipses to the plot

#malware status for Inc PDF
T1 = table(mydata$`inc PDF`,mydata$`Verified as Malware`); T1
Total<-sum
addmargins(round(prop.table(T1,2)*100,2), FUN = Total)

#malware status for unknown format
T2 = table(mydata$`Unknown Format`,mydata$`Verified as Malware`); T2
Total<-sum
addmargins(round(prop.table(T2,2)*100,2), FUN = Total)

#malware IQR calculation for Email Size feature
a1=aggregate(mydata$`Email Size`~mydata$`Verified as Malware`, data = mydata, FUN = IQR)
a2=aggregate(mydata$`Num attachments`~mydata$`Verified as Malware`, data = mydata, FUN = IQR)
a3=aggregate(mydata$`Email Size`~mydata$`Verified as Malware`, data = mydata, FUN = median); a3
a4=aggregate(mydata$`Num attachments`~mydata$`Verified as Malware`, data = mydata, FUN = median); a4
a1; a2
View(a1); View(a2)
